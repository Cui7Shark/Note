# OTA

| 791  | 02 $06^*$ 01 00 00 00 00 00 |
| ---- | --------------------------- |
|      |                             |

带有*的字节内容，表示认证报文状态； 01 认证请求， 02 认证响应，03 诊断设备计算认证的消息，04 VDC（GW）计算认证的消息， 05 心跳包， 06 认证通过状态。



## OTA子系统概述

### 系统功能清单

1. 版本检测
2. 



## OTA升级流程

1. 全域进入扩展会话流程

   TBOX发送功能寻址10 83，控制器进入扩展会话模式，TBOX忽略负响应。

   TBOX发送功能寻址3E 80,让控制器保持诊断会话模式，每2s发送一次。

2. 刷写/安装准备流程
   发送物理寻址``31 01 02 03``，对目标控制器进行编程条件检测，OTA模式下，控制器直接回复通过的正响应
   发送功能寻址85 82，网段内所有控制器禁止记录DTC；并延时500ms，TBOX模块忽略负响应。
   发送F 28 83 01，禁止发送应用报文。
   发送F 28 83 03，禁止发应用报文和网络管理报文。
   发送P 22 F0 F0，读取目标控制器运行区，控制器回复负响应，TBOX模块判定控制器不是**双分区**控制器，负响应不影响后续流程执行，控制器回复正响应，TBOX判定控制器是双分区控制器。

3. 刷写/安装执行流程
   发送物理寻址10 02，让目标控制器进入编程诊断会话模式中；如果控制器需要重启后才能进入编程会话，会先返回NRC 78，待ECU复位后进入编程会话后再响应10 02。
   发送27 09/0A，发起安全访问。
   发送物理寻址2E F1 84，对目标控制器写入指纹信息，用于查看刷写规范。
   TBOX模块依照Bootloader刷写规范中的“文件传输”或“刷写”执行。
   发送物理寻址31 01 FF 01，要求目标控制器对传输/刷写的数据进行数据兼容校验。

4. 刷写/安装完成流程
   发送P11 01， 控制器硬复位，等待5秒执行后续。
   发送P14 FF FF FF，清除目标控制器故障码
   发送F10 83，控制器进入诊断扩展模式，延时500ms

   发送F85 82，控制禁止记录DTC，延时500ms

   发送P22 02 16，读取目标控制器软件版本号。

5. 重刷流程
   发送P11 01，控制器硬复位，等待5秒。
   发送F10 83，控制器进入诊断扩展模式，延时500ms

   TBOX 模块重新按照刷写/安装准备流程发送指令；
   TBOX 模块重新按照刷写/安装执行流程发送指令；

6. 版本回滚流程
   如果控制器刷写失败，重刷平台配置次数后仍然失败，执行版本回退。双分区的自己恢复，不满足的需要TBOX执行回滚操作。

## OTA退出流程

1. 开启通讯
   TBOX发送功能寻址28 80 01，控制器打开应用报文。

   发送28 80 03，控制器打开应用报文和网络管理报文。

2. 清除所有故障码
   TBOX发送14 FF FF FF, 清楚所有控制器故障码
   发送85 81，开启记录DTC
   发送10 81， 进入默认会话模式。

3. 获取资产信息

   发送电源ON档控制信号。整车执行低压和高压上电流程。
   发送物理寻址22 XX XX，读取所有控制器对应资产信息（XX XX 表示对应诊断DID）

   包括零部件件号、软件版本号、供应商代码、。。。

   TBOX发送电源OFF档控制信号，整车执行高压和低压下电流程。
   发送TBOX_OTAModeStatus=0x1:InActive, 各控制器推出OTA模式。

   TBOX停止发送3E 80诊断服务。

## OTA升级异常退出

原因：

1. 控制器自身故障
2. 控制器刷写例程负响应退出
3. 供电停止断电
4. 动力电池热失控

规避措施：控制器支持双分区、支持高压刷写升级、动力电池和蓄电池型号满足刷写时长需求。